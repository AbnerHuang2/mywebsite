<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Mysql插入删除死锁问题排查 &#183; Skitii</title><meta name=title content="Mysql插入删除死锁问题排查 &#183; Skitii"><link rel=canonical href=/posts/mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/><link type=text/css rel=stylesheet href=/css/main.bundle.min.3552466d62941f854cc764b706ab5b2e3616325dd23313577f99ff83f095a09e436d4734656eb0ab9f588d93c251fdf636660a728c2f6ccb49697325daac8a6c.css integrity="sha512-NVJGbWKUH4VMx2S3BqtbLjYWMl3SMxNXf5n/g/CVoJ5DbUc0ZW6wq59YjZPCUf32NmYKcowvbMtJaXMl2qyKbA=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.15ae6e2c9b1ac24a9ccf40003fa689efb1a18db1ee9b73d780b01a6c31b150441415862513e93184f68fe385759e4698b8763cba6a0f79493c1fed99ad5868d4.js integrity="sha512-Fa5uLJsawkqcz0AAP6aJ77GhjbHum3PXgLAabDGxUEQUFYYlE+kxhPaP44V1nkaYuHY8umoPeUk8H+2ZrVho1A==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Mysql插入删除死锁问题排查"><meta property="og:description" content="搞懂Mysql插入删除是如何加锁的"><meta property="og:type" content="article"><meta property="og:url" content="/posts/mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-10T19:58:16+00:00"><meta property="article:modified_time" content="2022-02-10T19:58:16+00:00"><meta property="og:site_name" content="Skitii"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mysql插入删除死锁问题排查"><meta name=twitter:description content="搞懂Mysql插入删除是如何加锁的"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"Mysql插入删除死锁问题排查","headline":"Mysql插入删除死锁问题排查","description":"搞懂Mysql插入删除是如何加锁的","abstract":"查看业务日志 查看死锁日志 show engine innodb status; （查询语句）","inLanguage":"en","url":"\/posts\/mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5\/","author":{"@type":"Person","name":"Skitii"},"copyrightYear":"2022","dateCreated":"2022-02-10T19:58:16\u002b00:00","datePublished":"2022-02-10T19:58:16\u002b00:00","dateModified":"2022-02-10T19:58:16\u002b00:00","keywords":["Mysql","问题排查"],"mainEntityOfPage":"true","wordCount":"1033"}]</script><meta name=author content="Skitii"></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Skitii</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title>Blog</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/categories/ title=Categories>Categories</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>Tags</a></li><li class="ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><button id=search-button class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/></a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/>Mysql插入删除死锁问题排查</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Mysql插入删除死锁问题排查</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-02-10 19:58:16 +0000 UTC">10 February 2022</time><span class="px-2 text-primary-500">&#183;</span><span>1033 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">5 mins</span></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/categories/mysql/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">Mysql</a>
<a href=/tags/mysql/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">Mysql</a>
<a href=/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">问题排查</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#insert加锁过程>insert加锁过程</a></li><li><a href=#结论>结论</a></li></ul></li></ul></li></ul><ul><li><ul><li><ul><li><a href=#复现1原因分析>复现1原因分析：</a></li><li><a href=#复现2原因分析>复现2原因分析：</a></li><li><a href=#业务死锁分析>业务死锁分析</a></li></ul></li></ul></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><meta name=referrer content="no-referrer"><h1 id=查看业务日志 class="relative group">查看业务日志</h1><p><figure><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642074072500-6db92ae1-eaff-462f-af20-9f0fb579d2c0.png#clientId=u1d0a973d-d39c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=207&id=uc5138bc1&margin=%5Bobject%20Object%5D&name=image.png&originHeight=207&originWidth=961&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81604&status=done&style=none&taskId=u9feaf1b7-3944-4bda-b069-fb48f7151cd&title=&width=961" alt=image.png></figure></p><h1 id=查看死锁日志 class="relative group">查看死锁日志</h1><p>show engine innodb status; （查询语句）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=n>LATEST</span> <span class=n>DETECTED</span> <span class=n>DEADLOCK</span>
</span></span><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=mi>2022</span><span class=o>-</span><span class=mo>01</span><span class=o>-</span><span class=mi>12</span> <span class=mi>08</span><span class=o>:</span><span class=mi>24</span><span class=o>:</span><span class=mi>23</span> <span class=mh>0x7f5a5cf75700</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务A
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>9400396</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>0</span> <span class=n>sec</span> <span class=n>inserting</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>LOCK</span> <span class=n>WAIT</span> <span class=mi>3</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>1136</span><span class=p>,</span> <span class=mi>2</span> <span class=n>row</span> <span class=n>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2138935</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140026474653440</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>58338774</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>update</span>
</span></span><span class=line><span class=cl><span class=n>insert</span> <span class=n>into</span> <span class=n>t_device_online</span> <span class=p>(</span><span class=n>device_id</span><span class=p>,</span> <span class=n>start_time</span><span class=p>,</span> <span class=n>end_time</span><span class=p>,</span><span class=n>online_times</span><span class=p>)</span> <span class=n>values</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>133</span><span class=p>,</span> <span class=mi>1641975738</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>137</span><span class=p>,</span> <span class=mi>1641975727</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>138</span><span class=p>,</span> <span class=mi>1641975743</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>144</span><span class=p>,</span> <span class=mi>1641975726</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>146</span><span class=p>,</span> <span class=mi>1641975742</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>147</span><span class=p>,</span> <span class=mi>1641975728</span><span class=p>,</span> <span class=mi>1641975862</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>150</span><span class=p>,</span> <span class=mi>1641975724</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>152</span><span class=p>,</span> <span class=mi>1641975746</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>154</span><span class=p>,</span> <span class=mi>1641975744</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>28</span><span class=p>,</span> <span class=mi>1641975737</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>158</span><span class=p>,</span> <span class=mi>1641975744</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=mi>1641975736</span><span class=p>,</span> <span class=mi>1641975862</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>162</span><span class=p>,</span> <span class=mi>1641975733</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>36</span><span class=p>,</span> <span class=mi>1641975736</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>168</span><span class=p>,</span> <span class=mi>1641975729</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>40</span><span class=p>,</span> <span class=mi>1641975732</span><span class=p>,</span> <span class=n>n</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30559</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>9400396</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>gap</span> <span class=n>before</span> <span class=n>rec</span> <span class=n>insert</span> <span class=n>intention</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务B
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>9400297</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>1</span> <span class=n>sec</span> <span class=n>fetching</span> <span class=n>rows</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=mi>72</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>24784</span><span class=p>,</span> <span class=mi>1748</span> <span class=n>row</span> <span class=n>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2138649</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140026083497728</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>58338328</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>updating</span>
</span></span><span class=line><span class=cl><span class=n>delete</span> <span class=n>from</span> <span class=n>t_device_online</span> <span class=n>where</span> <span class=n>end_time</span> <span class=n>is</span> <span class=n>null</span>
</span></span><span class=line><span class=cl>            <span class=n>and</span> <span class=n>device_id</span> <span class=n>in</span>
</span></span><span class=line><span class=cl>             <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=mi>133</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>137</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>138</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>144</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>146</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>147</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>150</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>152</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>154</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>28</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>158</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>32</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>162</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>36</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>168</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>40</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>10536</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>169</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>170</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>42</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>10411</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>171</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>172</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>HOLDS</span> <span class=n>THE</span> <span class=n>LOCK</span><span class=p>(</span><span class=n>S</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30559</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>9400297</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>gap</span> <span class=n>before</span> <span class=n>rec</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30545</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>672</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>9400297</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=n>WE</span> <span class=n>ROLL</span> <span class=n>BACK</span> <span class=n>TRANSACTION</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></div><table><thead><tr><th>事务A（insert）</th><th>事务B（delete）</th></tr></thead><tbody><tr><td></td><td>​</td></tr><tr><td></td><td></td></tr><tr><td></td><td>持有行锁 824 index（X锁）</td></tr><tr><td>等行锁 824 index（X锁）</td><td></td></tr><tr><td></td><td>等行锁 672 index（X锁）</td></tr><tr><td>回滚</td><td></td></tr></tbody></table><p>从死锁日志上，可以，事务A并没有持有事务B所需要的资源啊，但是从现象上来看，事务A应该是持有了672的行锁。那我们就必须先了解insert的加锁过程。</p><h1 id=insert加锁 class="relative group">insert加锁</h1><p><figure><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642377267905-4e7f60c8-004b-4c62-9313-7e4a6d6738c5.png#clientId=ub48be365-8441-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=293&id=u060c8838&margin=%5Bobject%20Object%5D&name=image.png&originHeight=586&originWidth=1910&originalType=binary&ratio=1&rotation=0&showTitle=false&size=181462&status=done&style=none&taskId=u5f6f6851-c0a1-4849-a00b-ee7576e4bdb&title=&width=955" alt=image.png></figure></p><h4 id=insert加锁过程 class="relative group">insert加锁过程</h4><ol><li>先加插入意向Gap锁(insert intention gap lock)【如果别的事务已经有了这个间隙的锁Gap Lock，就无法加insert intention gap lock】</li><li>然后对插入的记录加索引记录锁（index-record lock）不会加gap锁，不影响其他insert的执行，除非他们插入的记录的索引值相同。</li><li>如果插入的记录索引值相同，则会出现duplicate-key error，就会对改索引加一个共享锁（shared lock）。但是如果有多个请求同时插入同一个索引值，这种情况可能会出现死锁。</li></ol><p>举个例子：</p><table><thead><tr><th>事务A</th><th>事务B</th><th>事务C</th></tr></thead><tbody><tr><td>START TRANSACTION;</td><td>​</td><td></td></tr><tr><td>​</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>INSERT INTO t1 VALUES(1);</td><td>START TRANSACTION;</td><td>START TRANSACTION;</td></tr><tr><td>获取到index-record lock(也是这个行记录的排查锁)</td><td>INSERT INTO t1 VALUES(1);</td><td>INSERT INTO t1 VALUES(1);</td></tr><tr><td>增加shared lock</td><td>遇到duplicate-key error</td><td>遇到duplicate-key error</td></tr><tr><td>​</td><td></td><td></td></tr><tr><td>等待shared lock</td><td>等待shared lock</td><td></td></tr><tr><td>ROLLBACK;</td><td>​</td><td></td></tr><tr><td>​</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>释放shared lock</td><td>获取到shared lock</td><td>获取到shared lock</td></tr><tr><td>释放排查锁</td><td>等待排查锁</td><td>等待排查锁</td></tr><tr><td></td><td>死锁</td><td>死锁</td></tr></tbody></table><p>事务B和C都获取到了shared lock，都在等待排他锁，但是排他锁和shared lock互斥，所以事务B和C都获取不到排他锁。（想要获取排他锁必须等对方释放shared lock，但是这是不可能的）
<strong>还有一种情况也会产生死锁</strong></p><table><thead><tr><th>事务A</th><th>事务B</th><th>事务C</th></tr></thead><tbody><tr><td>START TRANSACTION;</td><td>​</td><td></td></tr><tr><td>​</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>delete from t1 where id = 1;</td><td>START TRANSACTION;</td><td>START TRANSACTION;</td></tr><tr><td>获取到index-record lock(也是这个行记录的排查锁)</td><td>INSERT INTO t1 VALUES(1);</td><td>INSERT INTO t1 VALUES(1);</td></tr><tr><td>增加shared lock</td><td>遇到duplicate-key error</td><td>遇到duplicate-key error</td></tr><tr><td>​</td><td></td><td></td></tr><tr><td>等待shared lock</td><td>等待shared lock</td><td></td></tr><tr><td>commit;</td><td>​</td><td></td></tr><tr><td>​</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>释放shared lock</td><td>获取到shared lock</td><td>获取到shared lock</td></tr><tr><td>释放排查锁</td><td>等待排查锁</td><td>等待排查锁</td></tr><tr><td></td><td>死锁</td><td>死锁</td></tr></tbody></table><h4 id=结论 class="relative group">结论</h4><p><strong>三个以上的并发插入，如果一个回滚了，可能会存在死锁（原因是出现</strong>duplicate-key error，其他事务都获取不到排他锁**）**
<strong>一个删除，两个并发插入，删除提交后也会造成死锁。</strong>
​</p><h1 id=delete加锁 class="relative group">Delete加锁</h1><p><figure><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642516633446-beceaa9f-6468-424d-b493-0dcf38284708.png#clientId=u56f5bcdf-874a-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=65&id=u9e1f885a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=130&originWidth=1896&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38765&status=done&style=none&taskId=u443b9767-dbf8-4aaf-9327-418f0eb25c4&title=&width=948" alt=image.png></figure>delete加锁过程</p><ol><li>设置一个next-key的排他锁在每个搜索的行记录。（意味着除了占住行锁，还会占住间隙锁）</li><li>对于使用唯一索引搜索的情况只会对搜索的行加索引记录锁</li></ol><h1 id=复现 class="relative group">复现</h1><p>复现方式1<figure><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642595958486-9b6c7bd9-d820-4732-88de-07943b535904.png#clientId=u8b19cdb6-bf92-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=348&id=u90cbff8d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=348&originWidth=881&originalType=binary&ratio=1&rotation=0&showTitle=false&size=57322&status=done&style=none&taskId=ua0cb8125-6d19-43f7-b468-58cae125d82&title=&width=881" alt=image.png></figure><figure><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642595985011-eea742e4-e772-4304-9191-370751e251c0.png#clientId=u8b19cdb6-bf92-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=171&id=u59c09004&margin=%5Bobject%20Object%5D&name=image.png&originHeight=171&originWidth=560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16731&status=done&style=none&taskId=u8ec56e12-27bd-4d24-b07f-767c578af60&title=&width=560" alt=image.png></figure>执行步骤：</p><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td>开始事务</td><td></td></tr><tr><td></td><td>开始事务</td></tr><tr><td>插入133</td><td></td></tr><tr><td></td><td>删除137</td></tr><tr><td>插入137</td><td></td></tr><tr><td></td><td>提交</td></tr><tr><td>死锁</td><td></td></tr></tbody></table><p>死锁日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=n>LATEST</span> <span class=n>DETECTED</span> <span class=n>DEADLOCK</span>
</span></span><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=mi>2022</span><span class=o>-</span><span class=mo>01</span><span class=o>-</span><span class=mi>19</span> <span class=mi>12</span><span class=o>:</span><span class=mi>38</span><span class=o>:</span><span class=mi>16</span> <span class=mh>0x7f59772d9700</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务A
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>10649448</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>136</span> <span class=n>sec</span> <span class=n>inserting</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>LOCK</span> <span class=n>WAIT</span> <span class=mi>3</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>1136</span><span class=p>,</span> <span class=mi>2</span> <span class=n>row</span> <span class=n>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2419529</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140026471950080</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>66144333</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>update</span>
</span></span><span class=line><span class=cl><span class=cm>/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;dev_with_high_pri.sql&gt; */</span> <span class=n>insert</span> <span class=n>into</span> <span class=n>t_device_online</span> <span class=p>(</span><span class=n>device_id</span><span class=p>,</span> <span class=n>start_time</span><span class=p>,</span> <span class=n>end_time</span><span class=p>,</span><span class=n>online_times</span><span class=p>)</span> <span class=n>values</span><span class=p>(</span><span class=mi>137</span><span class=p>,</span> <span class=mi>1641975727</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30554</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10649448</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>gap</span> <span class=n>before</span> <span class=n>rec</span> <span class=n>insert</span> <span class=n>intention</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务B
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>10649665</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>28</span> <span class=n>sec</span> <span class=n>fetching</span> <span class=n>rows</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=mi>35</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>8400</span><span class=p>,</span> <span class=mi>203</span> <span class=n>row</span> <span class=n>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2419581</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140022228293376</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>66144549</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>updating</span>
</span></span><span class=line><span class=cl><span class=cm>/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;Script-4.sql&gt; */</span> <span class=n>delete</span> <span class=n>from</span> <span class=n>t_device_online</span> <span class=n>where</span> <span class=n>device_id</span> <span class=n>in</span> <span class=p>(</span><span class=mi>133</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>HOLDS</span> <span class=n>THE</span> <span class=n>LOCK</span><span class=p>(</span><span class=n>S</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30554</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10649665</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>gap</span> <span class=n>before</span> <span class=n>rec</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30545</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>712</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10649665</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=n>WE</span> <span class=n>ROLL</span> <span class=n>BACK</span> <span class=n>TRANSACTION</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></div><hr><p>复现方式2<figure><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642599276279-94f84360-1e7f-4148-8f2f-ae77161bb0b6.png#clientId=u23a50d9c-b0fd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=112&id=ubb856f14&margin=%5Bobject%20Object%5D&name=image.png&originHeight=224&originWidth=1460&originalType=binary&ratio=1&rotation=0&showTitle=false&size=145102&status=done&style=none&taskId=ud9cda12f-cdd1-41cf-aff1-c5099cc89ce&title=&width=730" alt=image.png></figure><figure><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642599253891-c90bea14-e1f4-459d-9090-b4996782ea4a.png#clientId=u23a50d9c-b0fd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=170&id=u2e2ac32f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=340&originWidth=1342&originalType=binary&ratio=1&rotation=0&showTitle=false&size=113383&status=done&style=none&taskId=ucf365b65-f865-4d54-bc6d-ed21d32a4df&title=&width=671" alt=image.png></figure>执行过程</p><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td>开始事务</td><td></td></tr><tr><td></td><td>开始事务</td></tr><tr><td>插入137</td><td></td></tr><tr><td></td><td>删除137,133</td></tr><tr><td>插入133</td><td></td></tr><tr><td>死锁</td><td>​</td></tr><tr><td></td><td></td></tr><tr><td>​</td><td></td></tr><tr><td></td><td></td></tr></tbody></table><p>死锁日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=n>LATEST</span> <span class=n>DETECTED</span> <span class=n>DEADLOCK</span>
</span></span><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=mi>2022</span><span class=o>-</span><span class=mo>01</span><span class=o>-</span><span class=mi>19</span> <span class=mi>12</span><span class=o>:</span><span class=mi>58</span><span class=o>:</span><span class=mi>59</span> <span class=mh>0x7f5a74376700</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务A
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>10652218</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>4</span> <span class=n>sec</span> <span class=n>starting</span> <span class=n>index</span> <span class=n>read</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>LOCK</span> <span class=n>WAIT</span> <span class=mi>5</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>1136</span><span class=p>,</span> <span class=mi>5</span> <span class=n>row</span> <span class=n>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2420044</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140022237755136</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>66160375</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>updating</span>
</span></span><span class=line><span class=cl><span class=cm>/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;Script-4.sql&gt; */</span> <span class=n>delete</span> <span class=n>from</span> <span class=n>t_device_online</span> <span class=n>where</span> <span class=n>device_id</span> <span class=n>in</span> <span class=p>(</span><span class=mi>137</span><span class=p>,</span><span class=mi>133</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30554</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10652218</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务B
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>10652205</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>10</span> <span class=n>sec</span> <span class=n>inserting</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=mi>3</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>1136</span><span class=p>,</span> <span class=mi>2</span> <span class=n>row</span> <span class=n>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2420043</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140026473572096</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>66160420</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>update</span>
</span></span><span class=line><span class=cl><span class=cm>/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;dev_with_high_pri.sql&gt; */</span> <span class=n>insert</span> <span class=n>into</span> <span class=n>t_device_online</span> <span class=p>(</span><span class=n>device_id</span><span class=p>,</span> <span class=n>start_time</span><span class=p>,</span> <span class=n>end_time</span><span class=p>,</span><span class=n>online_times</span><span class=p>)</span> <span class=n>values</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>133</span><span class=p>,</span> <span class=mi>1641975727</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>HOLDS</span> <span class=n>THE</span> <span class=n>LOCK</span><span class=p>(</span><span class=n>S</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30554</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10652205</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>rec</span> <span class=n>but</span> <span class=n>not</span> <span class=n>gap</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30545</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>712</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10652205</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>gap</span> <span class=n>before</span> <span class=n>rec</span> <span class=n>insert</span> <span class=n>intention</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=n>WE</span> <span class=n>ROLL</span> <span class=n>BACK</span> <span class=n>TRANSACTION</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></div><hr><h1 id=死锁原因分析 class="relative group">死锁原因分析</h1><p>虽然复现方式不一样，但是死锁日志是一样的。</p><h4 id=复现1原因分析 class="relative group">复现1原因分析：</h4><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td>开始事务</td><td></td></tr><tr><td></td><td>开始事务</td></tr><tr><td>插入133（插入index-recode-lock，意向排他锁，是一个隐式排他锁）</td><td></td></tr><tr><td></td><td>删除137（获取了137的行锁及周围间隙锁）</td></tr><tr><td>​</td><td></td></tr><tr><td>删除133</td><td></td></tr><tr><td>（发现133有隐式排他锁，就帮他加上记录锁。</td><td></td></tr><tr><td>等待133的排他锁，也就是133的行锁）</td><td></td></tr><tr><td>插入137（等待137周围的间隙锁）</td><td>​</td></tr><tr><td></td><td></td></tr><tr><td>死锁</td><td></td></tr></tbody></table><h4 id=复现2原因分析 class="relative group">复现2原因分析：</h4><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td>开始事务</td><td></td></tr><tr><td></td><td>开始事务</td></tr><tr><td>插入137（插入index-recode-lock，意向排他锁，是一个隐式排他锁）</td><td></td></tr><tr><td></td><td>删除137,133 （获取了133的行锁，等待137的行锁）【这里可以说明删除会对in重排序，不然不会造成死锁】</td></tr><tr><td>插入133（等待133的行锁）</td><td></td></tr><tr><td>死锁</td><td>​</td></tr><tr><td></td><td></td></tr><tr><td>​</td><td></td></tr><tr><td></td><td></td></tr></tbody></table><h4 id=业务死锁分析 class="relative group">业务死锁分析</h4><ol><li>insert执行流程长，拿到了一些device_id</li><li>insert执行过程中，delete 对 in 里面的device_id进行排序，然后先于insert拿到后面要执行的device_id，但是需要等待insert已经获取的device_id。</li><li>insert要等delete已获取的device_id</li><li>就死锁了</li></ol><p><strong>待验证</strong>
为什么delete会对in里面的device_id重排序？
我觉得是因为删除语句没有走索引，要全表扫描，mysql为了避免随机IO，就对in的device_id排序了。
为什么insert 不会？
insert默认是通过主键id去查找，然后插入都是很快的，所以不需要重排序。
​</p><p>复现1和复现2和最开始的死锁日志一致。
如果复现1还不能说明问题的话，复现2就很能说明问题了。只要insert的够慢，delete 先拿到insert接下来要删除的行锁，就会死锁。
​</p><h1 id=参考 class="relative group">参考</h1><p><a href=https://blog.csdn.net/varyall/article/details/80219459>https://blog.csdn.net/varyall/article/details/80219459</a> (insert加锁分析)
<a href=https://cloud.tencent.com/developer/article/1900240>https://cloud.tencent.com/developer/article/1900240</a> (insert加锁分析)
<a href=https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html>https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html</a> （mysql官网innodb加锁说明）
<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-locks-set.html>https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-locks-set.html</a>(中文文档)</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="w-24 h-24 !mt-0 !mb-0 ltr:mr-4 rtl:ml-4 rounded-full" width=96 height=96 alt=Skitii src=/img/skitii_hu0ebb3515a05949aa5cc2e713a429c943_14031_192x192_fill_box_smart1_3.png><div class=place-self-center><div class="text-[0.6rem] leading-3 text-neutral-500 dark:text-neutral-400 uppercase">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Skitii</div><div class="text-2xl sm:text-lg"></div></div></div><script src=https://utteranc.es/client.js repo=AbnerHuang2/mywebsite issue-term=pathname theme=gruvbox-dark crossorigin=anonymous async></script><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group" href=/posts/orderby%E8%B8%A9%E5%9D%91%E4%B9%8B%E8%B7%AF/><span class="mr-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">OrderBy踩坑之路</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-02-10 20:13:06 +0000 UTC">10 February 2022</time></span></span></a></span>
<span><a class="flex text-right group" href=/posts/%E7%AB%99%E5%9C%A8%E4%BD%BF%E7%94%A8%E8%A7%92%E5%BA%A6%E7%9C%8B%E7%BC%93%E5%AD%98/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">站在使用角度看缓存</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-02-09 19:27:10 +0000 UTC">9 February 2022</time></span></span>
<span class="ml-3 ltr:inline rtl:hidden text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 ltr:hidden rtl:inline text-neutral-700 dark:text-neutral group-hover:text-primary-600 dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2022
Skitii</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"><button id=appearance-switcher class="w-12 h-12" type=button title="Switch to dark appearance">
<span class="inline dark:hidden"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></span><span class="hidden dark:inline"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></span></button></div></div></footer><script type=text/javascript src=https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js></script>
<script type=text/javascript src=https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.0.min.js></script>
<script type=text/javascript>L2Dwidget.init({model:{scale:1,hHeadPos:.5,vHeadPos:.618,jsonPath:"https://cdn.jsdelivr.net/npm/live2d-widget-model-koharu/assets/koharu.model.json"},display:{superSample:1,width:120,height:300,position:"right",hOffset:0,vOffset:0},mobile:{show:!0,scale:1,motion:!0},react:{opacityDefault:.8,opacityOnHover:1}})</script><div id=search-wrapper class="fixed inset-0 z-50 flex flex-col p-4 sm:p-6 md:p-[10vh] lg:p-[12vh] w-screen h-screen cursor-default bg-neutral-500/50 backdrop-blur-sm dark:bg-neutral-900/50 invisible" data-url><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg border-neutral-200 top-20 bg-neutral dark:bg-neutral-800 dark:border-neutral-700"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-transparent focus:outline-2" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>