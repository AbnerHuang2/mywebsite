<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>Mysql插入删除死锁问题排查 &#183; Skitii</title>
<meta name=title content="Mysql插入删除死锁问题排查 &#183; Skitii"><meta name=description content="搞懂Mysql插入删除是如何加锁的"><link rel=canonical href=https://skitii.vercel.app/posts/mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/><link type=text/css rel=stylesheet href=/css/main.bundle.min.a6debbb9c2752cfaaf987cbf5014fd1df44fb95b3494591ae67b7f8b99579a03.css integrity="sha256-pt67ucJ1LPqvmHy/UBT9HfRPuVs0lFka5nt/i5lXmgM="><script type=text/javascript src=/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.0dcadb6ce89e2df1ab4711fe1face40764013a10cb7e9d6d9faa1dab782b693e.js integrity="sha256-DcrbbOieLfGrRxH+H6zkB2QBOhDLfp1tn6odq3graT4=" data-copy=Copy data-copied=Copied></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=google-site-verification content="PeC9Clz1swOOWEProA3d9p39srZKONgJreLma19x0Cc"><meta property="og:title" content="Mysql插入删除死锁问题排查"><meta property="og:description" content="搞懂Mysql插入删除是如何加锁的"><meta property="og:type" content="article"><meta property="og:url" content="https://skitii.vercel.app/posts/mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-10T19:58:16+00:00"><meta property="article:modified_time" content="2022-02-10T19:58:16+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mysql插入删除死锁问题排查"><meta name=twitter:description content="搞懂Mysql插入删除是如何加锁的"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"Mysql插入删除死锁问题排查","headline":"Mysql插入删除死锁问题排查","description":"搞懂Mysql插入删除是如何加锁的","inLanguage":"en","url":"https:\/\/skitii.vercel.app\/posts\/mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5\/","author":{"@type":"Person","name":"Skitii"},"copyrightYear":"2022","dateCreated":"2022-02-10T19:58:16\u002b00:00","datePublished":"2022-02-10T19:58:16\u002b00:00","dateModified":"2022-02-10T19:58:16\u002b00:00","keywords":["问题排查"],"mainEntityOfPage":"true","wordCount":"2804"}]</script><meta name=author content="Skitii"></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold pe-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a href=/ class=mr-2><img src=/img/octopus.png width=64 height=64 class="max-h-[10rem] max-w-[10rem] object-scale-down object-left hidden dark:flex" alt=Skitii loading=lazy>
<img src=/img/octopus.png width=64 height=64 class="max-h-[10rem] max-w-[10rem] object-scale-down object-left dark:hidden" alt=Skitii loading=lazy></a></div><ul class="flex list-none flex-col ltr:text-right rtl:text-left sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/posts/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Blog</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/categories/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Categories</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/tags/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Tags</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><button id=search-button-m0 title="Search (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/></a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/>Mysql插入删除死锁问题排查</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Mysql插入删除死锁问题排查</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center">&lt;time datetime="2022-02-10 19:58:16 &amp;#43;0000 UTC">10 February 2022&lt;/time>&lt;span class="px-2 text-primary-500">&amp;middot;&lt;/span>&lt;span>2804 words&lt;/span>&lt;span class="px-2 text-primary-500">&amp;middot;&lt;/span>&lt;span title="Reading time">6 mins&lt;/span></div><div class="my-1 text-xs leading-relaxed text-neutral-500 dark:text-neutral-400"><a href=/categories/mysql/ class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">Mysql</a>
<a href=/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/ class="rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">问题排查</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 print:hidden lg:sticky lg:top-10"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="-ms-5 block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="-ms-5 border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#查看业务日志>查看业务日志</a></li><li><a href=#查看死锁日志>查看死锁日志</a></li><li><a href=#insert加锁>insert加锁</a><ul><li><ul><li><a href=#insert加锁过程>insert加锁过程</a></li><li><a href=#结论>结论</a></li></ul></li></ul></li><li><a href=#delete加锁>Delete加锁</a></li><li><a href=#复现>复现</a></li><li><a href=#死锁原因分析>死锁原因分析</a><ul><li><ul><li><a href=#复现1原因分析>复现1原因分析：</a></li><li><a href=#复现2原因分析>复现2原因分析：</a></li><li><a href=#业务死锁分析>业务死锁分析</a></li></ul></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose grow"><meta name=referrer content="no-referrer"><h2 id=查看业务日志 class="relative group">查看业务日志</h2><p><figure><div class=post-img-view><a data-fancybox=gallery href="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642074072500-6db92ae1-eaff-462f-af20-9f0fb579d2c0.png#clientId=u1d0a973d-d39c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=207&amp;id=uc5138bc1&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=207&amp;originWidth=961&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=81604&amp;status=done&amp;style=none&amp;taskId=u9feaf1b7-3944-4bda-b069-fb48f7151cd&amp;title=&amp;width=961"><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642074072500-6db92ae1-eaff-462f-af20-9f0fb579d2c0.png#clientId=u1d0a973d-d39c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=207&amp;id=uc5138bc1&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=207&amp;originWidth=961&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=81604&amp;status=done&amp;style=none&amp;taskId=u9feaf1b7-3944-4bda-b069-fb48f7151cd&amp;title=&amp;width=961" alt=image.png></a></div></figure></p><h2 id=查看死锁日志 class="relative group">查看死锁日志</h2><p>show engine innodb status; （查询语句）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=n>LATEST</span> <span class=n>DETECTED</span> <span class=n>DEADLOCK</span>
</span></span><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=mi>2022</span><span class=o>-</span><span class=mo>01</span><span class=o>-</span><span class=mi>12</span> <span class=mi>08</span><span class=o>:</span><span class=mi>24</span><span class=o>:</span><span class=mi>23</span> <span class=mh>0x7f5a5cf75700</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务A
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>9400396</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>0</span> <span class=n>sec</span> <span class=n>inserting</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>LOCK</span> <span class=n>WAIT</span> <span class=mi>3</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>1136</span><span class=p>,</span> <span class=mi>2</span> <span class=n>row</span> <span class=nf>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2138935</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140026474653440</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>58338774</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>update</span>
</span></span><span class=line><span class=cl><span class=n>insert</span> <span class=n>into</span> <span class=nf>t_device_online</span> <span class=p>(</span><span class=n>device_id</span><span class=p>,</span> <span class=n>start_time</span><span class=p>,</span> <span class=n>end_time</span><span class=p>,</span><span class=n>online_times</span><span class=p>)</span> <span class=nf>values</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>133</span><span class=p>,</span> <span class=mi>1641975738</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>137</span><span class=p>,</span> <span class=mi>1641975727</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>138</span><span class=p>,</span> <span class=mi>1641975743</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>144</span><span class=p>,</span> <span class=mi>1641975726</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>146</span><span class=p>,</span> <span class=mi>1641975742</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>147</span><span class=p>,</span> <span class=mi>1641975728</span><span class=p>,</span> <span class=mi>1641975862</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>150</span><span class=p>,</span> <span class=mi>1641975724</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>152</span><span class=p>,</span> <span class=mi>1641975746</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>154</span><span class=p>,</span> <span class=mi>1641975744</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>28</span><span class=p>,</span> <span class=mi>1641975737</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>158</span><span class=p>,</span> <span class=mi>1641975744</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=mi>1641975736</span><span class=p>,</span> <span class=mi>1641975862</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>162</span><span class=p>,</span> <span class=mi>1641975733</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>36</span><span class=p>,</span> <span class=mi>1641975736</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>168</span><span class=p>,</span> <span class=mi>1641975729</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=mi>40</span><span class=p>,</span> <span class=mi>1641975732</span><span class=p>,</span> <span class=n>n</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30559</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>9400396</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>gap</span> <span class=n>before</span> <span class=n>rec</span> <span class=n>insert</span> <span class=n>intention</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务B
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>9400297</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>1</span> <span class=n>sec</span> <span class=n>fetching</span> <span class=n>rows</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=mi>72</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>24784</span><span class=p>,</span> <span class=mi>1748</span> <span class=n>row</span> <span class=nf>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2138649</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140026083497728</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>58338328</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>updating</span>
</span></span><span class=line><span class=cl><span class=n>delete</span> <span class=n>from</span> <span class=n>t_device_online</span> <span class=n>where</span> <span class=n>end_time</span> <span class=n>is</span> <span class=n>null</span>
</span></span><span class=line><span class=cl>            <span class=n>and</span> <span class=n>device_id</span> <span class=nf>in</span>
</span></span><span class=line><span class=cl>             <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=mi>133</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>137</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>138</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>144</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>146</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>147</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>150</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>152</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>154</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>28</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>158</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>32</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>162</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>36</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>168</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>40</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>10536</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>169</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>170</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>42</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>10411</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>171</span>
</span></span><span class=line><span class=cl>             <span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>172</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>HOLDS</span> <span class=n>THE</span> <span class=nf>LOCK</span><span class=p>(</span><span class=n>S</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30559</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>9400297</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>gap</span> <span class=n>before</span> <span class=n>rec</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30545</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>672</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>9400297</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=n>WE</span> <span class=n>ROLL</span> <span class=n>BACK</span> <span class=nf>TRANSACTION</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></div><table><thead><tr><th>事务A（insert）</th><th>事务B（delete）</th></tr></thead><tbody><tr><td></td><td>​</td></tr><tr><td></td><td></td></tr><tr><td></td><td>持有行锁 824 index（X锁）</td></tr><tr><td>等行锁 824 index（X锁）</td><td></td></tr><tr><td></td><td>等行锁 672 index（X锁）</td></tr><tr><td>回滚</td><td></td></tr></tbody></table><p>从死锁日志上，可以，事务A并没有持有事务B所需要的资源啊，但是从现象上来看，事务A应该是持有了672的行锁。那我们就必须先了解insert的加锁过程。</p><h2 id=insert加锁 class="relative group">insert加锁</h2><p><figure><div class=post-img-view><a data-fancybox=gallery href="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642377267905-4e7f60c8-004b-4c62-9313-7e4a6d6738c5.png#clientId=ub48be365-8441-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=293&amp;id=u060c8838&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=586&amp;originWidth=1910&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=181462&amp;status=done&amp;style=none&amp;taskId=u5f6f6851-c0a1-4849-a00b-ee7576e4bdb&amp;title=&amp;width=955"><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642377267905-4e7f60c8-004b-4c62-9313-7e4a6d6738c5.png#clientId=ub48be365-8441-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=293&amp;id=u060c8838&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=586&amp;originWidth=1910&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=181462&amp;status=done&amp;style=none&amp;taskId=u5f6f6851-c0a1-4849-a00b-ee7576e4bdb&amp;title=&amp;width=955" alt=image.png></a></div></figure></p><h4 id=insert加锁过程 class="relative group">insert加锁过程</h4><ol><li>先加插入意向Gap锁(insert intention gap lock)【如果别的事务已经有了这个间隙的锁Gap Lock，就无法加insert intention gap lock】</li><li>然后对插入的记录加索引记录锁（index-record lock）不会加gap锁，不影响其他insert的执行，除非他们插入的记录的索引值相同。</li><li>如果插入的记录索引值相同，则会出现duplicate-key error，就会对改索引加一个共享锁（shared lock）。但是如果有多个请求同时插入同一个索引值，这种情况可能会出现死锁。</li></ol><p>举个例子：</p><table><thead><tr><th>事务A</th><th>事务B</th><th>事务C</th></tr></thead><tbody><tr><td>START TRANSACTION;</td><td>​</td><td></td></tr><tr><td>​</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>INSERT INTO t1 VALUES(1);</td><td>START TRANSACTION;</td><td>START TRANSACTION;</td></tr><tr><td>获取到index-record lock(也是这个行记录的排查锁)</td><td>INSERT INTO t1 VALUES(1);</td><td>INSERT INTO t1 VALUES(1);</td></tr><tr><td>增加shared lock</td><td>遇到duplicate-key error</td><td>遇到duplicate-key error</td></tr><tr><td>​</td><td></td><td></td></tr><tr><td>等待shared lock</td><td>等待shared lock</td><td></td></tr><tr><td>ROLLBACK;</td><td>​</td><td></td></tr><tr><td>​</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>释放shared lock</td><td>获取到shared lock</td><td>获取到shared lock</td></tr><tr><td>释放排查锁</td><td>等待排查锁</td><td>等待排查锁</td></tr><tr><td></td><td>死锁</td><td>死锁</td></tr></tbody></table><p>事务B和C都获取到了shared lock，都在等待排他锁，但是排他锁和shared lock互斥，所以事务B和C都获取不到排他锁。（想要获取排他锁必须等对方释放shared lock，但是这是不可能的）
<strong>还有一种情况也会产生死锁</strong></p><table><thead><tr><th>事务A</th><th>事务B</th><th>事务C</th></tr></thead><tbody><tr><td>START TRANSACTION;</td><td>​</td><td></td></tr><tr><td>​</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>delete from t1 where id = 1;</td><td>START TRANSACTION;</td><td>START TRANSACTION;</td></tr><tr><td>获取到index-record lock(也是这个行记录的排查锁)</td><td>INSERT INTO t1 VALUES(1);</td><td>INSERT INTO t1 VALUES(1);</td></tr><tr><td>增加shared lock</td><td>遇到duplicate-key error</td><td>遇到duplicate-key error</td></tr><tr><td>​</td><td></td><td></td></tr><tr><td>等待shared lock</td><td>等待shared lock</td><td></td></tr><tr><td>commit;</td><td>​</td><td></td></tr><tr><td>​</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>释放shared lock</td><td>获取到shared lock</td><td>获取到shared lock</td></tr><tr><td>释放排查锁</td><td>等待排查锁</td><td>等待排查锁</td></tr><tr><td></td><td>死锁</td><td>死锁</td></tr></tbody></table><h4 id=结论 class="relative group">结论</h4><p><strong>三个以上的并发插入，如果一个回滚了，可能会存在死锁（原因是出现</strong>duplicate-key error，其他事务都获取不到排他锁**）**
<strong>一个删除，两个并发插入，删除提交后也会造成死锁。</strong>
​</p><h2 id=delete加锁 class="relative group">Delete加锁</h2><p><figure><div class=post-img-view><a data-fancybox=gallery href="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642516633446-beceaa9f-6468-424d-b493-0dcf38284708.png#clientId=u56f5bcdf-874a-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=65&amp;id=u9e1f885a&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=130&amp;originWidth=1896&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=38765&amp;status=done&amp;style=none&amp;taskId=u443b9767-dbf8-4aaf-9327-418f0eb25c4&amp;title=&amp;width=948"><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642516633446-beceaa9f-6468-424d-b493-0dcf38284708.png#clientId=u56f5bcdf-874a-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=65&amp;id=u9e1f885a&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=130&amp;originWidth=1896&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=38765&amp;status=done&amp;style=none&amp;taskId=u443b9767-dbf8-4aaf-9327-418f0eb25c4&amp;title=&amp;width=948" alt=image.png></a></div></figure>delete加锁过程</p><ol><li>设置一个next-key的排他锁在每个搜索的行记录。（意味着除了占住行锁，还会占住间隙锁）</li><li>对于使用唯一索引搜索的情况只会对搜索的行加索引记录锁</li></ol><h2 id=复现 class="relative group">复现</h2><p>复现方式1<figure><div class=post-img-view><a data-fancybox=gallery href="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642595958486-9b6c7bd9-d820-4732-88de-07943b535904.png#clientId=u8b19cdb6-bf92-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=348&amp;id=u90cbff8d&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=348&amp;originWidth=881&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=57322&amp;status=done&amp;style=none&amp;taskId=ua0cb8125-6d19-43f7-b468-58cae125d82&amp;title=&amp;width=881"><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642595958486-9b6c7bd9-d820-4732-88de-07943b535904.png#clientId=u8b19cdb6-bf92-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=348&amp;id=u90cbff8d&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=348&amp;originWidth=881&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=57322&amp;status=done&amp;style=none&amp;taskId=ua0cb8125-6d19-43f7-b468-58cae125d82&amp;title=&amp;width=881" alt=image.png></a></div></figure><figure><div class=post-img-view><a data-fancybox=gallery href="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642595985011-eea742e4-e772-4304-9191-370751e251c0.png#clientId=u8b19cdb6-bf92-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=171&amp;id=u59c09004&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=171&amp;originWidth=560&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=16731&amp;status=done&amp;style=none&amp;taskId=u8ec56e12-27bd-4d24-b07f-767c578af60&amp;title=&amp;width=560"><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642595985011-eea742e4-e772-4304-9191-370751e251c0.png#clientId=u8b19cdb6-bf92-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=171&amp;id=u59c09004&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=171&amp;originWidth=560&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=16731&amp;status=done&amp;style=none&amp;taskId=u8ec56e12-27bd-4d24-b07f-767c578af60&amp;title=&amp;width=560" alt=image.png></a></div></figure>执行步骤：</p><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td>开始事务</td><td></td></tr><tr><td></td><td>开始事务</td></tr><tr><td>插入133</td><td></td></tr><tr><td></td><td>删除137</td></tr><tr><td>插入137</td><td></td></tr><tr><td></td><td>提交</td></tr><tr><td>死锁</td><td></td></tr></tbody></table><p>死锁日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=n>LATEST</span> <span class=n>DETECTED</span> <span class=n>DEADLOCK</span>
</span></span><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=mi>2022</span><span class=o>-</span><span class=mo>01</span><span class=o>-</span><span class=mi>19</span> <span class=mi>12</span><span class=o>:</span><span class=mi>38</span><span class=o>:</span><span class=mi>16</span> <span class=mh>0x7f59772d9700</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务A
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>10649448</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>136</span> <span class=n>sec</span> <span class=n>inserting</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>LOCK</span> <span class=n>WAIT</span> <span class=mi>3</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>1136</span><span class=p>,</span> <span class=mi>2</span> <span class=n>row</span> <span class=nf>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2419529</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140026471950080</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>66144333</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>update</span>
</span></span><span class=line><span class=cl><span class=cm>/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;dev_with_high_pri.sql&gt; */</span> <span class=n>insert</span> <span class=n>into</span> <span class=nf>t_device_online</span> <span class=p>(</span><span class=n>device_id</span><span class=p>,</span> <span class=n>start_time</span><span class=p>,</span> <span class=n>end_time</span><span class=p>,</span><span class=n>online_times</span><span class=p>)</span> <span class=nf>values</span><span class=p>(</span><span class=mi>137</span><span class=p>,</span> <span class=mi>1641975727</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30554</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10649448</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>gap</span> <span class=n>before</span> <span class=n>rec</span> <span class=n>insert</span> <span class=n>intention</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务B
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>10649665</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>28</span> <span class=n>sec</span> <span class=n>fetching</span> <span class=n>rows</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=mi>35</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>8400</span><span class=p>,</span> <span class=mi>203</span> <span class=n>row</span> <span class=nf>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2419581</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140022228293376</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>66144549</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>updating</span>
</span></span><span class=line><span class=cl><span class=cm>/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;Script-4.sql&gt; */</span> <span class=n>delete</span> <span class=n>from</span> <span class=n>t_device_online</span> <span class=n>where</span> <span class=n>device_id</span> <span class=nf>in</span> <span class=p>(</span><span class=mi>133</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>HOLDS</span> <span class=n>THE</span> <span class=nf>LOCK</span><span class=p>(</span><span class=n>S</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30554</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10649665</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>gap</span> <span class=n>before</span> <span class=n>rec</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30545</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>712</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10649665</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=n>WE</span> <span class=n>ROLL</span> <span class=n>BACK</span> <span class=nf>TRANSACTION</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></div><hr><p>复现方式2<figure><div class=post-img-view><a data-fancybox=gallery href="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642599276279-94f84360-1e7f-4148-8f2f-ae77161bb0b6.png#clientId=u23a50d9c-b0fd-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=112&amp;id=ubb856f14&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=224&amp;originWidth=1460&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=145102&amp;status=done&amp;style=none&amp;taskId=ud9cda12f-cdd1-41cf-aff1-c5099cc89ce&amp;title=&amp;width=730"><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642599276279-94f84360-1e7f-4148-8f2f-ae77161bb0b6.png#clientId=u23a50d9c-b0fd-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=112&amp;id=ubb856f14&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=224&amp;originWidth=1460&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=145102&amp;status=done&amp;style=none&amp;taskId=ud9cda12f-cdd1-41cf-aff1-c5099cc89ce&amp;title=&amp;width=730" alt=image.png></a></div></figure><figure><div class=post-img-view><a data-fancybox=gallery href="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642599253891-c90bea14-e1f4-459d-9090-b4996782ea4a.png#clientId=u23a50d9c-b0fd-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=170&amp;id=u2e2ac32f&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=340&amp;originWidth=1342&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=113383&amp;status=done&amp;style=none&amp;taskId=ucf365b65-f865-4d54-bc6d-ed21d32a4df&amp;title=&amp;width=671"><img class="my-0 rounded-md" src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642599253891-c90bea14-e1f4-459d-9090-b4996782ea4a.png#clientId=u23a50d9c-b0fd-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=170&amp;id=u2e2ac32f&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=340&amp;originWidth=1342&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=113383&amp;status=done&amp;style=none&amp;taskId=ucf365b65-f865-4d54-bc6d-ed21d32a4df&amp;title=&amp;width=671" alt=image.png></a></div></figure>执行过程</p><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td>开始事务</td><td></td></tr><tr><td></td><td>开始事务</td></tr><tr><td>插入137</td><td></td></tr><tr><td></td><td>删除137,133</td></tr><tr><td>插入133</td><td></td></tr><tr><td>死锁</td><td>​</td></tr><tr><td></td><td></td></tr><tr><td>​</td><td></td></tr><tr><td></td><td></td></tr></tbody></table><p>死锁日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=n>LATEST</span> <span class=n>DETECTED</span> <span class=n>DEADLOCK</span>
</span></span><span class=line><span class=cl><span class=o>------------------------</span>
</span></span><span class=line><span class=cl><span class=mi>2022</span><span class=o>-</span><span class=mo>01</span><span class=o>-</span><span class=mi>19</span> <span class=mi>12</span><span class=o>:</span><span class=mi>58</span><span class=o>:</span><span class=mi>59</span> <span class=mh>0x7f5a74376700</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务A
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>10652218</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>4</span> <span class=n>sec</span> <span class=n>starting</span> <span class=n>index</span> <span class=n>read</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>LOCK</span> <span class=n>WAIT</span> <span class=mi>5</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>1136</span><span class=p>,</span> <span class=mi>5</span> <span class=n>row</span> <span class=nf>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2420044</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140022237755136</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>66160375</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>updating</span>
</span></span><span class=line><span class=cl><span class=cm>/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;Script-4.sql&gt; */</span> <span class=n>delete</span> <span class=n>from</span> <span class=n>t_device_online</span> <span class=n>where</span> <span class=n>device_id</span> <span class=nf>in</span> <span class=p>(</span><span class=mi>137</span><span class=p>,</span><span class=mi>133</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30554</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10652218</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=nl>TRANSACTION</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>//事务B
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>TRANSACTION</span> <span class=mi>10652205</span><span class=p>,</span> <span class=n>ACTIVE</span> <span class=mi>10</span> <span class=n>sec</span> <span class=n>inserting</span>
</span></span><span class=line><span class=cl><span class=n>mysql</span> <span class=n>tables</span> <span class=n>in</span> <span class=n>use</span> <span class=mi>1</span><span class=p>,</span> <span class=n>locked</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=mi>3</span> <span class=n>lock</span> <span class=k>struct</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>heap</span> <span class=n>size</span> <span class=mi>1136</span><span class=p>,</span> <span class=mi>2</span> <span class=n>row</span> <span class=nf>lock</span><span class=p>(</span><span class=n>s</span><span class=p>),</span> <span class=n>undo</span> <span class=n>log</span> <span class=n>entries</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>MySQL</span> <span class=kr>thread</span> <span class=n>id</span> <span class=mi>2420043</span><span class=p>,</span> <span class=n>OS</span> <span class=kr>thread</span> <span class=n>handle</span> <span class=mi>140026473572096</span><span class=p>,</span> <span class=n>query</span> <span class=n>id</span> <span class=mi>66160420</span> <span class=mf>10.21.17.247</span> <span class=n>liuchuangzhao</span> <span class=n>update</span>
</span></span><span class=line><span class=cl><span class=cm>/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;dev_with_high_pri.sql&gt; */</span> <span class=n>insert</span> <span class=n>into</span> <span class=nf>t_device_online</span> <span class=p>(</span><span class=n>device_id</span><span class=p>,</span> <span class=n>start_time</span><span class=p>,</span> <span class=n>end_time</span><span class=p>,</span><span class=n>online_times</span><span class=p>)</span> <span class=nf>values</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=mi>133</span><span class=p>,</span> <span class=mi>1641975727</span><span class=p>,</span> <span class=mi>1641975861</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>HOLDS</span> <span class=n>THE</span> <span class=nf>LOCK</span><span class=p>(</span><span class=n>S</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30554</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>824</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10652205</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>rec</span> <span class=n>but</span> <span class=n>not</span> <span class=n>gap</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=n>WAITING</span> <span class=n>FOR</span> <span class=n>THIS</span> <span class=n>LOCK</span> <span class=n>TO</span> <span class=n>BE</span> <span class=nl>GRANTED</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>RECORD</span> <span class=n>LOCKS</span> <span class=n>space</span> <span class=n>id</span> <span class=mi>61</span> <span class=n>page</span> <span class=n>no</span> <span class=mi>30545</span> <span class=n>n</span> <span class=n>bits</span> <span class=mi>712</span> <span class=n>index</span> <span class=n>device_id</span> <span class=n>of</span> <span class=n>table</span> <span class=err>`</span><span class=n>ifp_remote_platform</span><span class=err>`</span><span class=p>.</span><span class=err>`</span><span class=n>t_device_online</span><span class=err>`</span> <span class=n>trx</span> <span class=n>id</span> <span class=mi>10652205</span> <span class=n>lock_mode</span> <span class=n>X</span> <span class=n>locks</span> <span class=n>gap</span> <span class=n>before</span> <span class=n>rec</span> <span class=n>insert</span> <span class=n>intention</span> <span class=n>waiting</span>
</span></span><span class=line><span class=cl><span class=o>***</span> <span class=n>WE</span> <span class=n>ROLL</span> <span class=n>BACK</span> <span class=nf>TRANSACTION</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></div><hr><h2 id=死锁原因分析 class="relative group">死锁原因分析</h2><p>虽然复现方式不一样，但是死锁日志是一样的。</p><h4 id=复现1原因分析 class="relative group">复现1原因分析：</h4><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td>开始事务</td><td></td></tr><tr><td></td><td>开始事务</td></tr><tr><td>插入133（插入index-recode-lock，意向排他锁，是一个隐式排他锁）</td><td></td></tr><tr><td></td><td>删除137（获取了137的行锁及周围间隙锁）</td></tr><tr><td>​</td><td></td></tr><tr><td>删除133</td><td></td></tr><tr><td>（发现133有隐式排他锁，就帮他加上记录锁。</td><td></td></tr><tr><td>等待133的排他锁，也就是133的行锁）</td><td></td></tr><tr><td>插入137（等待137周围的间隙锁）</td><td>​</td></tr><tr><td></td><td></td></tr><tr><td>死锁</td><td></td></tr></tbody></table><h4 id=复现2原因分析 class="relative group">复现2原因分析：</h4><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td>开始事务</td><td></td></tr><tr><td></td><td>开始事务</td></tr><tr><td>插入137（插入index-recode-lock，意向排他锁，是一个隐式排他锁）</td><td></td></tr><tr><td></td><td>删除137,133 （获取了133的行锁，等待137的行锁）【这里可以说明删除会对in重排序，不然不会造成死锁】</td></tr><tr><td>插入133（等待133的行锁）</td><td></td></tr><tr><td>死锁</td><td>​</td></tr><tr><td></td><td></td></tr><tr><td>​</td><td></td></tr><tr><td></td><td></td></tr></tbody></table><h4 id=业务死锁分析 class="relative group">业务死锁分析</h4><ol><li>insert执行流程长，拿到了一些device_id</li><li>insert执行过程中，delete 对 in 里面的device_id进行排序，然后先于insert拿到后面要执行的device_id，但是需要等待insert已经获取的device_id。</li><li>insert要等delete已获取的device_id</li><li>就死锁了</li></ol><p><strong>待验证</strong>
为什么delete会对in里面的device_id重排序？
我觉得是因为删除语句没有走索引，要全表扫描，mysql为了避免随机IO，就对in的device_id排序了。
为什么insert 不会？
insert默认是通过主键id去查找，然后插入都是很快的，所以不需要重排序。
​</p><p>复现1和复现2和最开始的死锁日志一致。
如果复现1还不能说明问题的话，复现2就很能说明问题了。只要insert的够慢，delete 先拿到insert接下来要删除的行锁，就会死锁。
​</p><h2 id=参考 class="relative group">参考</h2><p><a href=https://blog.csdn.net/varyall/article/details/80219459 target=_blank rel="noreferrer noopener">https://blog.csdn.net/varyall/article/details/80219459</a> (insert加锁分析)
<a href=https://cloud.tencent.com/developer/article/1900240 target=_blank rel="noreferrer noopener">https://cloud.tencent.com/developer/article/1900240</a> (insert加锁分析)
<a href=https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html target=_blank rel="noreferrer noopener">https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html</a> （mysql官网innodb加锁说明）
<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-locks-set.html target=_blank rel="noreferrer noopener">https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-locks-set.html</a>(中文文档)</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mb-0 !mt-0 me-4 h-24 w-24 rounded-full" width=96 height=96 alt=Skitii src=/img/donatello_hu71dba6f0b14209fcd6a03b819133ef67_44229_192x192_fill_box_center_3.png loading=lazy><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Skitii</div><div class="text-2xl sm:text-lg"></div></div></div><script src=https://utteranc.es/client.js repo=AbnerHuang2/mywebsite issue-term=pathname theme=gruvbox-dark crossorigin=anonymous async></script><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/orderby%E8%B8%A9%E5%9D%91%E4%B9%8B%E8%B7%AF/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">OrderBy踩坑之路</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-02-10 20:13:06 +0000 UTC">10 February 2022</time>
</span></span></a></span><span><a class="group flex text-right" href=/posts/%E7%AB%99%E5%9C%A8%E4%BD%BF%E7%94%A8%E8%A7%92%E5%BA%A6%E7%9C%8B%E7%BC%93%E5%AD%98/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">站在使用角度看缓存</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-02-09 19:27:10 +0000 UTC">9 February 2022</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024
Skitii</p></div><div class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14"><button id=appearance-switcher class="w-12 h-12" type=button title="Switch to dark appearance">
<span class="inline dark:hidden"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg>
</span></span><span class="hidden dark:inline"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></span></button></div></div></footer><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.0.min.js></script><script>(function(e,t,n){t.ChatraID="H8oixnws8SKYQkjBz";var s=e.createElement("script");t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},s.async=!0,s.src="https://call.chatra.io/chatra.js",e.head&&e.head.appendChild(s)})(document,window,"Chatra")</script><script type=text/javascript>L2Dwidget.init({model:{scale:1,hHeadPos:.5,vHeadPos:.618,jsonPath:"https://unpkg.com/live2d-widget-model-nito@1.0.5/assets/nito.model.json"},display:{superSample:1,width:120,height:300,position:"right",hOffset:20,vOffset:0},mobile:{show:!0,scale:1,motion:!0},react:{opacityDefault:.8,opacityOnHover:1}})</script><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://skitii.vercel.app/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>